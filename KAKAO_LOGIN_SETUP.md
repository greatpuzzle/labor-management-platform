# 카카오톡 로그인 설정 가이드

## 개요

근로자가 카카오 계정으로 로그인할 수 있도록 카카오 로그인 기능을 설정합니다.

## 필요한 정보

### 1. 카카오 개발자 콘솔 설정

#### 1-1. 카카오 개발자 콘솔 접속
- URL: https://developers.kakao.com/
- 카카오 계정으로 로그인

#### 1-2. 애플리케이션 등록
1. **내 애플리케이션** → **애플리케이션 추가하기**
2. 앱 이름 입력 (예: "장애인 근로관리")
3. 앱 생성 완료

#### 1-3. 앱 키 확인
생성된 앱의 **앱 설정** → **앱 키**에서 다음 키 확인:
- **JavaScript 키** (VITE_KAKAO_JS_KEY로 사용)
  - 예: `abc123def456ghi789jkl012mno345pq`

#### 1-4. 플랫폼 설정
**앱 설정** → **플랫폼**에서 플랫폼 추가:

**Web 플랫폼 추가:**
- 사이트 도메인: `http://43.200.44.109:3001` (프로덕션)
- 또는 `http://localhost:5174` (개발 환경)

**Android 플랫폼 추가 (모바일 앱용):**
- 패키지 이름: `com.ecospott.labor` (또는 실제 패키지명)
- 키 해시: (선택사항, 나중에 추가 가능)

**iOS 플랫폼 추가 (모바일 앱용):**
- 번들 ID: `com.ecospott.labor` (또는 실제 번들 ID)

#### 1-5. 카카오 로그인 활성화
**제품 설정** → **카카오 로그인** → **활성화 설정**:
- **카카오 로그인** 활성화 ON

#### 1-6. Redirect URI 설정
**제품 설정** → **카카오 로그인** → **Redirect URI**:
- **Redirect URI 등록** 클릭
- 다음 URI 추가:
  ```
  http://43.200.44.109:3001
  http://localhost:5174
  ```
  (프로덕션과 개발 환경 모두 등록)

#### 1-7. 동의 항목 설정
**제품 설정** → **카카오 로그인** → **동의항목**:
- **필수 동의 항목**:
  - 카카오계정(이메일): 선택 (필요시)
  - 전화번호: **필수** ✅
    - 전화번호는 로그인 시 근로자 매칭에 사용됩니다
- **선택 동의 항목**:
  - 프로필 정보(닉네임/프로필 사진): 선택

## 환경 변수 설정

### 2. 모바일 앱 환경 변수 설정

`apps/mobile/.env` 파일 생성 또는 수정:

```env
# 카카오 JavaScript SDK 키
VITE_KAKAO_JS_KEY=your-javascript-key-here
```

**예시:**
```env
VITE_KAKAO_JS_KEY=abc123def456ghi789jkl012mno345pq
```

### 3. 백엔드 환경 변수 (선택사항)

백엔드는 카카오 액세스 토큰만 받으면 되므로 **추가 설정이 필요 없습니다**.

다만, 카카오 API를 직접 호출하는 경우를 대비해 REST API 키를 저장할 수 있습니다:

`apps/backend/.env` 파일에 추가 (선택사항):
```env
# 카카오 REST API 키 (선택사항, 현재는 사용하지 않음)
KAKAO_REST_API_KEY=your-rest-api-key-here
```

## 동작 방식

### 로그인 플로우

1. **근로자가 "카카오로 로그인" 버튼 클릭**
   - 카카오 JavaScript SDK 초기화 (VITE_KAKAO_JS_KEY 사용)
   - 카카오 로그인 팝업 표시

2. **카카오 계정으로 로그인**
   - 카카오 인증 완료
   - 액세스 토큰 발급

3. **백엔드로 액세스 토큰 전송**
   - `POST /api/employees/login-by-kakao`
   - 액세스 토큰을 백엔드로 전송

4. **백엔드에서 카카오 사용자 정보 조회**
   - 카카오 API 호출: `https://kapi.kakao.com/v2/user/me`
   - 카카오 ID와 전화번호 추출

5. **근로자 매칭**
   - 카카오 ID로 근로자 조회
   - 없으면 전화번호로 조회
   - 찾으면 카카오 ID 저장

6. **로그인 완료**
   - 근로자 정보 반환
   - 모바일 앱에서 로그인 상태 저장

## 테스트 방법

### 1. 개발 환경 테스트

1. **환경 변수 설정 확인**
   ```bash
   # apps/mobile/.env 파일 확인
   cat apps/mobile/.env
   ```

2. **모바일 앱 실행**
   ```bash
   cd apps/mobile
   npm run dev
   ```

3. **카카오 로그인 버튼 클릭**
   - 카카오 로그인 팝업 표시 확인
   - 카카오 계정으로 로그인
   - 로그인 성공 확인

### 2. 프로덕션 환경 테스트

1. **환경 변수 설정**
   - EC2 서버에 배포된 모바일 앱의 환경 변수 확인
   - 또는 빌드 시 환경 변수 포함

2. **실제 카카오 계정으로 로그인 테스트**
   - 프로덕션 URL에서 카카오 로그인 시도
   - 로그인 성공 확인

## 주의사항

### 1. 카카오 로그인 동의 항목
- **전화번호는 필수 동의 항목으로 설정**해야 합니다
- 전화번호가 없으면 근로자 매칭이 불가능합니다

### 2. Redirect URI
- **정확한 도메인과 포트를 등록**해야 합니다
- `http://`와 `https://`는 별도로 등록해야 합니다
- 마지막에 `/`가 있으면 안 됩니다

### 3. JavaScript 키 보안
- JavaScript 키는 클라이언트에 노출되므로 보안에 취약합니다
- 하지만 카카오 로그인은 JavaScript 키만으로는 로그인할 수 없고, 사용자 동의가 필요합니다
- 백엔드에서 액세스 토큰을 검증하므로 안전합니다

### 4. 근로자 등록
- 카카오 로그인은 **이미 등록된 근로자만** 로그인할 수 있습니다
- 등록되지 않은 근로자는 "등록된 정보가 없습니다" 오류가 발생합니다
- 먼저 회사 초대 링크를 통해 근로자를 등록해야 합니다

## 문제 해결

### 1. "카카오 SDK가 초기화되지 않았습니다" 오류
- **원인**: `VITE_KAKAO_JS_KEY`가 설정되지 않았거나 잘못된 키
- **해결**: 
  - `apps/mobile/.env` 파일에 올바른 JavaScript 키 설정
  - 앱 재시작

### 2. "카카오 인증에 실패했습니다" 오류
- **원인**: Redirect URI가 등록되지 않았거나 잘못된 URI
- **해결**: 
  - 카카오 개발자 콘솔에서 Redirect URI 확인
  - 정확한 도메인과 포트 등록

### 3. "등록된 정보가 없습니다" 오류
- **원인**: 카카오 계정의 전화번호로 등록된 근로자가 없음
- **해결**: 
  - 먼저 회사 초대 링크를 통해 근로자 등록
  - 또는 근로자의 전화번호가 카카오 계정과 일치하는지 확인

### 4. 전화번호를 가져올 수 없음
- **원인**: 카카오 로그인 동의 항목에서 전화번호 동의를 하지 않음
- **해결**: 
  - 카카오 개발자 콘솔에서 전화번호를 필수 동의 항목으로 설정
  - 사용자가 로그인 시 전화번호 동의 필요

## 체크리스트

카카오 로그인 설정 완료 체크리스트:

- [ ] 카카오 개발자 콘솔에서 애플리케이션 생성
- [ ] JavaScript 키 확인
- [ ] Web 플랫폼 등록 (도메인 설정)
- [ ] Android/iOS 플랫폼 등록 (모바일 앱용)
- [ ] 카카오 로그인 활성화
- [ ] Redirect URI 등록
- [ ] 전화번호 동의 항목 필수로 설정
- [ ] `apps/mobile/.env`에 `VITE_KAKAO_JS_KEY` 설정
- [ ] 모바일 앱 재시작
- [ ] 카카오 로그인 테스트

## 관련 파일

- **프론트엔드**: `apps/mobile/src/components/PhoneLogin.tsx`
- **백엔드 API**: `apps/backend/src/employees/employees.controller.ts`
- **API 클라이언트**: `packages/shared/api.ts`
- **데이터베이스**: `apps/backend/prisma/schema.prisma` (kakaoId 필드)

## 참고 자료

- [카카오 개발자 문서 - 카카오 로그인](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api)
- [카카오 JavaScript SDK](https://developers.kakao.com/docs/latest/ko/getting-started/sdk-js)

---

**준비 완료!** 이제 카카오 로그인 기능을 사용할 수 있습니다! 🎉
